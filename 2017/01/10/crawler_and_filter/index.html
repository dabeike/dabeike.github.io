<!DOCTYPE html><html lang="en"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>浅谈动态爬虫与去重 | Fr1day's Blog</title><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/5.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-min.css"><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">浅谈动态爬虫与去重</h1><a id="logo" href="/.">Fr1day's Blog</a><p class="description"></p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> Home</i></a><a href="/archives/"><i class="fa fa-archive"> Archive</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">浅谈动态爬虫与去重</h1><div class="post-meta">Jan 10, 2017<script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><div class="post-content"><p>首发于360播报平台: <a href="http://bobao.360.cn/learning/detail/3391.html" target="_blank" rel="external">【技术分享】浅谈动态爬虫与去重</a></p>
<h2 id="0x01-简介"><a href="#0x01-简介" class="headerlink" title="0x01 简介"></a>0x01 简介</h2><p>随着web 2.0的发展，页面中的AJAX也越来越多。由于传统爬虫依靠静态分析，不能准确的抓取到页面中的AJAX请求以及动态更新的内容，已经越来越不能满足需求。基于动态解析的Web 2.0爬虫应运而生，通过浏览器内核解析页面源码，模拟用户操作，能有效解决上述问题。本文将详细分析利用PhantomJS + Python 编写爬虫并进行去重的思路。</p>
<h2 id="0x02-PhantomJS"><a href="#0x02-PhantomJS" class="headerlink" title="0x02 PhantomJS"></a>0x02 PhantomJS</h2><p><a href="http://phantomjs.org/" target="_blank" rel="external">PhantomJS</a> 是无界面的 Webkit 解析器，提供了 JavaScript API 。由于去除了可视化界面，速度比一般 Webkit 浏览器要快很多。同时提供了很多监控和事件接口，可以方便的操作 DOM 节点，模拟用户操作等。</p>
<p>接下来我们通过一个简单的例子，来展示下动态爬虫和传统爬虫的区别。目标：加载一个页面（<a href="http://named.cn/.mine" target="_blank" rel="external">那么，一起玩吧</a>），并且获取其中所有的<code>&lt;a&gt;</code>标签。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// example.js</span></div><div class="line"></div><div class="line"><span class="keyword">var</span> page = <span class="built_in">require</span>(<span class="string">'webpage'</span>).create();</div><div class="line"></div><div class="line">page.onAlert = <span class="function"><span class="keyword">function</span> (<span class="params">message</span>) </span>&#123;</div><div class="line">    <span class="built_in">console</span>.log(message);</div><div class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">page.onCallback = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">	page.evaluate(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">		atags = <span class="built_in">document</span>.getElementsByTagName(<span class="string">"a"</span>);</div><div class="line">		<span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;atags.length;i++)&#123;</div><div class="line">		    <span class="keyword">if</span> (atags[i].getAttribute(<span class="string">"href"</span>))&#123;</div><div class="line">		        alert(atags[i].getAttribute(<span class="string">"href"</span>));</div><div class="line">		    &#125;</div><div class="line">		&#125;</div><div class="line">	&#125;)</div><div class="line">	</div><div class="line">	phantom.exit()</div><div class="line">&#125;;</div><div class="line"></div><div class="line">page.open(<span class="string">"http://named.cn/.mine"</span>, <span class="string">"get"</span>, <span class="string">""</span>, <span class="function"><span class="keyword">function</span> (<span class="params">status</span>) </span>&#123;</div><div class="line">	page.evaluateAsync(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">		<span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="built_in">window</span>.callPhantom === <span class="string">'function'</span>) &#123;</div><div class="line">			<span class="built_in">window</span>.callPhantom();</div><div class="line">		&#125;</div><div class="line">	&#125;, <span class="number">10000</span>)</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>抓取结果如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">/.mine</div><div class="line">/cmd2/controls/signin</div><div class="line">/cmd2/controls/getcode</div><div class="line">/download.html</div><div class="line">/.blog</div><div class="line">/.mine</div><div class="line">/.at</div><div class="line">/~发现推荐.findbbs</div><div class="line">/help.html</div><div class="line">/江南水乡.bbs/7313348</div><div class="line">/摄情男女.bbs/7313242</div><div class="line">/欢乐一家亲.bbs/7313356</div><div class="line">/深夜食堂.bbs/7313168</div><div class="line">/家有熊孩子.bbs/7313321</div><div class="line">/乐淘亲子营.bbs/7313320</div><div class="line">.../*省略*/...</div><div class="line">/婚礼记.bbs/7277165</div><div class="line">/不知道的事情.bbs/7277164</div><div class="line">/不知道的事情.bbs/7277162</div><div class="line">/婚礼记.bbs/7277160</div><div class="line">/不知道的事情.bbs/7277016</div><div class="line">http://www.miitbeian.gov.cn/</div><div class="line">/cmd2/controls/mailpost/内容举报</div><div class="line">download.html</div></pre></td></tr></table></figure>
<p>静态抓取的代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> requests</div><div class="line"><span class="keyword">import</span> pyquery</div><div class="line"></div><div class="line">res = requests.get(<span class="string">"http://named.cn/.mine"</span>)</div><div class="line"></div><div class="line">count = <span class="number">0</span></div><div class="line">pq = pyquery.PyQuery(res.content)</div><div class="line"><span class="keyword">for</span> i <span class="keyword">in</span> pq(<span class="string">"a"</span>):</div><div class="line">	<span class="keyword">print</span> <span class="string">"[%d]: %s"</span> % (count, pq(i).attr(<span class="string">"href"</span>))</div></pre></td></tr></table></figure>
<p>抓取结果为空。</p>
<p>从上述的例子中，我们可以明显看出动态分析比静态分析抓取到了更多的结果。产生差别的原因，是页面中的数据加载来自于AJAX请求，所有的 <code>&lt;a&gt;</code> 标签都是动态更新到页面中的。静态分析对这种情况无能为力，而基于浏览器内核的动态分析，可以轻松的处理这些情况。</p>
<p>但也可以明显看出动态分析的缺点：系统资源占用较多，且占用时间较长，还会有一些莫名其妙的坑，编写起来也更复杂更花时间（需要对前端编程有一定的了解）。</p>
<p>当然除了 PhantomJS 还有一些其他的动态解析器，比如同样基于 Webkit 内核的 PyQt（PhantomJS的最新版本也是基于pyqt来实现）、基于 PhantomJS 封装的 CasperJS、基于的 Firefox Gecko 内核的SlimerJS等。由于并没有一个统一的标准，各个动态解析器的API实现程度也参差不齐，也会有各种各样的坑，并没有一个 “最佳” 的解决方案。</p>
<h2 id="0x03-触发事件及页面监听"><a href="#0x03-触发事件及页面监听" class="headerlink" title="0x03 触发事件及页面监听"></a>0x03 触发事件及页面监听</h2><p>上面的例子，介绍了爬虫中常见的一个场景：在页面加载完成后，通过AJAX加载数据。但现实中的场景，往往会更复杂，需要与用户进行交互后才会触发，比如在点击了某个按钮后跳转到某个页面、滚动到页面尾部后加载下一页的数据等。我们需要新的解决方案，去模拟正常用户的操作。那么，应该如何将用户交互抽象为代码？</p>
<p>用户操作的本质，实际上是触发了绑定在DOM节点的事件。所以模拟用户操作的问题，可以简化为触发节点事件。事件执行的结果也是多种多样的，但对于爬虫来说，我们需要关注的结果只有两种：1. 是否添加了新的节点（<code>&lt;a&gt;</code>、<code>&lt;iframe&gt;</code>等等） 2. 是否发起了新的请求（包括AJAX请求、跳转等）。简化后，我们需要解决的问题有：</p>
<ol>
<li>如何获取绑定事件？</li>
<li>如何触发事件？</li>
<li>如何获取事件触发的结果？</li>
</ol>
<p>最后我们的解决方案如下：</p>
<ol>
<li><p>如何获取绑定事件？JavaScript中绑定事件，都会调用<code>addEventListener</code>函数。在页面里的代码执行前（<a href="http://phantomjs.org/api/webpage/handler/on-initialized.html" target="_blank" rel="external">onInitialized | PhantomJS</a>），hook addEventListener函数，就可以捕获到哪些DOM节点绑定了事件。</p>
 <figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">_addEventListener = Element.prototype.addEventListener;</div><div class="line">Element.prototype.addEventListener = <span class="function"><span class="keyword">function</span>(<span class="params">a,b,c</span>) </span>&#123;</div><div class="line">    EVENT_LIST.push(&#123;<span class="string">"event"</span>: event, <span class="string">"element"</span>: <span class="keyword">this</span>&#125;)</div><div class="line">    _addEventListener.apply(<span class="keyword">this</span>, <span class="built_in">arguments</span>);</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
</li>
<li><p>如何触发事件？JavaScript中提供了<code>dispatchEvent</code>函数，可以触发指定DOM节点的指定事件，也就是上一个问题中，我们收集的<code>EVENT_LIST</code>。</p>
 <figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span>(<span class="keyword">var</span> i <span class="keyword">in</span> EVENT_LIST)&#123;</div><div class="line">    <span class="keyword">var</span> evt = <span class="built_in">document</span>.createEvent(<span class="string">'CustomEvent'</span>);</div><div class="line">    evt.initCustomEvent(EVENT_LIST[i][<span class="string">"event"</span>], <span class="literal">true</span>, <span class="literal">true</span>, <span class="literal">null</span>);</div><div class="line">    EVENT_LIST[i][<span class="string">"element"</span>].dispatchEvent(evt);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<p>除了通过<code>addEventListener</code>绑定事件，还有一些<code>inline-script</code>，是无法通过hook addEventListener来获取的。比如：</p>
<pre><code><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;div id=<span class="string">"test"</span> onclick=<span class="string">"alert('hello')"</span>&gt;<span class="xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></div></pre></td></tr></table></figure>
</code></pre><p>解决方法是遍历节点，执行所有的onxxxx属性的值。</p>
<pre><code><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">trigger_inline</span>(<span class="params"></span>)</span>&#123;</div><div class="line">       <span class="keyword">var</span> nodes = <span class="built_in">document</span>.all;</div><div class="line">       <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; nodes.length; i++) &#123;</div><div class="line">           <span class="keyword">var</span> attrs = nodes[i].attributes;</div><div class="line">           <span class="keyword">for</span> (<span class="keyword">var</span> j = <span class="number">0</span>; j &lt; attrs.length; j++) &#123;</div><div class="line">               attr_name = attrs[j].nodeName;</div><div class="line">               attr_value = attrs[j].nodeValue;</div><div class="line">               <span class="keyword">if</span> (attr_name.substr(<span class="number">0</span>, <span class="number">2</span>) == <span class="string">"on"</span>) &#123;</div><div class="line">                   <span class="built_in">console</span>.log(attrs[j].nodeName + <span class="string">' : '</span> + attr_value);</div><div class="line">                   <span class="built_in">eval</span>(attr_value);</div><div class="line">               &#125;</div><div class="line">               <span class="keyword">if</span> (attr_name <span class="keyword">in</span> &#123;<span class="string">"src"</span>: <span class="number">1</span>, <span class="string">"href"</span>: <span class="number">1</span>&#125; &amp;&amp; attrs[j].nodeValue.substr(<span class="number">0</span>, <span class="number">11</span>) == <span class="string">"javascript:"</span>) &#123;</div><div class="line">                   <span class="built_in">console</span>.log(attrs[j].nodeName + <span class="string">' : '</span> + attr_value);</div><div class="line">                   <span class="built_in">eval</span>(attr_value.substr(<span class="number">11</span>));</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
</code></pre><ol>
<li><p>如何获取事件触发的结果？HTML5中的<code>MutationObserver</code>方法，可以检查页面中的DOM是否发生变化。但是PhantomJS并不支持（摊手 <a href="https://github.com/ariya/phantomjs/issues/10715" target="_blank" rel="external">Support for Mutation Observers</a>），解决方案是监听了<code>DOMNodeInserted</code>事件。AJAX请求的捕获，解决方案有两种：<a href="http://phantomjs.org/api/webpage/handler/on-resource-requested.html" target="_blank" rel="external">onResourceRequested</a> 可以捕获非主框架的请求，但需要通过正则表达式匹配筛选出有效请求；hook <code>XMLHttpRequest.open</code> 和 <code>XMLHttpRequest.send</code> 可以准确的捕获请求内容。</p>
 <figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">document</span>.addEventListener(<span class="string">'DOMNodeInserted'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> node = e.target;</div><div class="line">    <span class="keyword">if</span>(node.src || node.href)&#123;</div><div class="line">        LINKS_RESULT.push(node.src || node.href);</div><div class="line">    &#125;</div><div class="line">&#125;, <span class="literal">true</span>);</div><div class="line"></div><div class="line">_open = XMLHttpRequest.prototype.open</div><div class="line">XMLHttpRequest.prototype.open = <span class="function"><span class="keyword">function</span> (<span class="params">method, url</span>) </span>&#123;</div><div class="line">	<span class="keyword">if</span> (!<span class="keyword">this</span>._url) &#123;</div><div class="line">		<span class="keyword">this</span>._url = url;</div><div class="line">		<span class="keyword">this</span>._method = method;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	_open.apply(<span class="keyword">this</span>, <span class="built_in">arguments</span>);</div><div class="line">&#125;;</div><div class="line"></div><div class="line">_send = XMLHttpRequest.prototype.send</div><div class="line">XMLHttpRequest.prototype.send = <span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</div><div class="line">	<span class="built_in">window</span>.$Result$.add_ajax(<span class="keyword">this</span>._url, <span class="keyword">this</span>._method, data);</div><div class="line"></div><div class="line">	_send.apply(<span class="keyword">this</span>, <span class="built_in">arguments</span>);</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
</li>
</ol>
<p>整理一下，在页面加载前，需要hook三个接口：<code>addEventListener</code>、<code>XMLHttpRequest.open</code>、<code>XMLHttpRequest.send</code>。页面加载完之后，需要获取所有的<code>&lt;a&gt;</code>、<code>&lt;iframe&gt;</code>、<code>&lt;form&gt;</code>标签，开启页面DOM节点监听，并且触发所有的事件。最后输出结果。</p>
<p>在实现了动态爬取的基本功能后，还有一些可以提升爬虫的稳定性和效率的小tips：自动填写表单（应对某些情况下参数为空导致表单无法提交）、禁止非必要资源的加载（jpg、png、css、mp4等）、页面加载完成后禁止跳转（防止因为触发事件导致的跳转）、hook会导致页面阻塞的函数（alert、prompt）、触发事件向下冒泡（解决一些不标准的前端代码绑定的DOM节点太宽泛导致的问题，但实测非常影响效率）等。</p>
<h2 id="0x04-去重"><a href="#0x04-去重" class="headerlink" title="0x04 去重"></a>0x04 去重</h2><p>去重是爬虫中最核心，也是最影响爬虫效率和结果的部分。去重过于粗放，在遇到页面比较多的网站时爬不完。过于严格的话，爬取的结果太少，也会影响后续扫描的效果。</p>
<p>去重一般分为两个部分：任务队列的去重、结果队列的去重。这两种去重的区别在于，在爬虫运行过程中，任务队列是一直变动的（增加 &amp; 减少），而结果队列是不断的增加的。对任务队列的去重，要在扫描过程中重复的进行的，即某个页面爬取完成后，获取的结果加入任务队列进行下一次爬虫任务之前，需要做一次去重（或者每完成一个深度的爬虫任务，进行一次去重），而结果队列是在所有的任务结束后进行去重，不影响爬虫运行效率，只影响最后的结果输出。这两种去重可以使用相同的去重策略，也可以使用不同的策略（对任务队列的去重，可以根据当前的任务量，进行去重力度的调整）。</p>
<p>我们将爬虫的功能和需求程度逐一列出来：</p>
<ol>
<li>基础： 非抓取目标站点的URL</li>
<li>基础： 完全重复的URL &amp; 参数打乱但实际上仍然重复的URL</li>
<li>温饱： 分析参数，去除遍历型的，exp: <code>page.php?id=1</code>、<code>page.php?id=2</code> 等</li>
<li>温饱： 支持伪静态URL去重</li>
<li>小康： 奇形怪状URL的去重，exp: <code>test.php?a=1?b=2?from=233</code>、 <code>test.php?a=1?b=3?from=test</code></li>
<li>小康： 根据当前的任务量，动态调整去重力度</li>
</ol>
<p>前两个基础需求实现起来比较简单，将域名、参数列表提取出来进行对比就可以了，一次循环解决问题。</p>
<p>第三个需求，需要匹配参数值，比如： int、hash、中文、URL编码等。需要注意的是，不可以直接用匹配的方式处理英文的参数值。如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">http://test.com/index.php?m=home&amp;c=test&amp;a=view</div><div class="line">http://test.com/index.php?m=home&amp;c=test&amp;a=add</div></pre></td></tr></table></figure>
<p>其中m、c、a参数分别代表了不同的module、controller、action，属于“ 功能型参数 ”，需要保留。功能性参数的值在大多数情况下是字母（有意义的单词），有些情况下也会是数字或者数字字母的混合。那么，应该如何做策略？ </p>
<p>这个问题目前的解决方案也比较粗暴，对全部是字母的参数值，不做处理，对数字字母混合的参数值，根据任务量的多少进行“ 弹力去重 ”（详见需求6）。举个实际的例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"># 去重处理前：</div><div class="line">http://test.com/index.php?m=home&amp;c=test&amp;id=3</div><div class="line">http://test.com/index.php?m=home&amp;c=test&amp;type=friday</div><div class="line">http://test.com/index.php?m=home&amp;c=test&amp;type=464730bbd7fb2016c880ffd597f2808f</div><div class="line">http://test.com/index.php?m=home&amp;c=test&amp;type=b59c67bf196a4758191e42f76670ceba</div><div class="line"></div><div class="line"># 处理过程：</div><div class="line">&#123;&quot;m&quot;: &quot;home&quot;, &quot;c&quot;: &quot;test&quot;, &quot;id&quot;:&quot;&#123;&#123;int&#125;&#125;&quot;&#125;</div><div class="line">&#123;&quot;m&quot;: &quot;home&quot;, &quot;c&quot;: &quot;test&quot;, &quot;id&quot;:&quot;&#123;&#123;int&#125;&#125;&quot;&#125;</div><div class="line">&#123;&quot;m&quot;: &quot;home&quot;, &quot;c&quot;: &quot;test&quot;, &quot;type&quot;:&quot;friday&quot;&#125;</div><div class="line">&#123;&quot;m&quot;: &quot;home&quot;, &quot;c&quot;: &quot;test&quot;, &quot;type&quot;:&quot;&#123;&#123;hash&#125;&#125;&quot;&#125;</div><div class="line">&#123;&quot;m&quot;: &quot;home&quot;, &quot;c&quot;: &quot;test&quot;, &quot;type&quot;:&quot;&#123;&#123;hash&#125;&#125;&quot;&#125;</div><div class="line"></div><div class="line"># 去重结果：</div><div class="line">http://test.com/index.php?m=home&amp;c=test&amp;id=2</div><div class="line">http://test.com/index.php?m=home&amp;c=test&amp;type=friday</div><div class="line">http://test.com/index.php?m=home&amp;c=test&amp;type=464730bbd7fb2016c880ffd597f2808f</div></pre></td></tr></table></figure>
<p>第四个需求，支持伪静态去重。首先要定义对路径去重的策略，我们把路径用<code>/</code>分隔开，扔到处理参数值的函数中去处理（符合规则的替换为指定字符串、不符合规则的原样返回），然后再用替换过的URL做去重处理就可以了。当然还有一些伪静态长这样：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">htttp://xxx.com/?index_1_test_233</div><div class="line">htttp://xxx.com/?index_1_new_456</div></pre></td></tr></table></figure>
<p>再按照上述的去重策略就过于粗略，应该怎么处理呢？继续往下看。</p>
<p>第五个需求，奇形怪状的URL。目前已有的去重策略都是通过分析替换参数值、路径名来实现的，但是这种奇奇怪怪的URL根本不按套路出牌，只能采用非常的方法：在参数、路径进行拆分处理前，替换掉一些干扰字符。举个实例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"># 处理前</div><div class="line">http://test.com/test.php?id=12?from=te?user=233</div><div class="line">http://test.com/test.php?id=12?from=te?user=233_abc</div><div class="line"></div><div class="line"># 替换后</div><div class="line">http://test.com/test.php?id=&#123;&#123;int&#125;&#125;?from=te?user=&#123;&#123;int&#125;&#125;</div><div class="line">http://test.com/test.php?id=&#123;&#123;int&#125;&#125;?from=te?user=&#123;&#123;mix_str&#125;&#125;</div></pre></td></tr></table></figure>
<p>第六个需求，根据当前的任务量，自动调整去重策略。在有些情况下，上述的各种去重套路都不好用，比如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">http://test.com/user.php?name=test</div><div class="line">http://test.com/user.php?name=今天是阴天</div><div class="line">http://test.com/user.php?name=bbbbb</div><div class="line">...</div></pre></td></tr></table></figure>
<p>当用户名为自定义，且有成千上万个用户的时候，上述的去重策略就都失效了。问题出在哪里？</p>
<p>需求三的解决方案似乎过于粗略了，直接把所有的纯英文字符串放过了，但是也没有更好的解决方案。只能针对这种特殊情况，再加一次循环，先找到出现次数过多的参数，再针对这些特定的参数进行强制去重。新的策略是这样的：第一次循环只进行预处理，分析当前的参数列表，并计数。第二遍，根据参数列表的计数值判断当前参数是否需要强制去重。举个实例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">http://test.com/index.php?name=friday&amp;m=read</div><div class="line">http://test.com/index.php?name=test&amp;m=read</div><div class="line">http://test.com/index.php?name=2333&amp;m=read</div><div class="line"></div><div class="line"># 第一轮遍历结果</div><div class="line"></div><div class="line">&#123;</div><div class="line">    md5(name+m):&#123;count:3, &quot;name&quot;:[&quot;friday&quot;,&quot;test&quot;,&quot;&#123;&#123;int&#125;&#125;&quot;], &quot;m&quot;: [&quot;read&quot;]&#125;,</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当参数列表相同的URL数量大于某个特定值，且某个参数的值的个数大于某个特定值的时候，强制对该参数进行去重，即将全英文字符串替换为<code></code>。</p>
<p>上述方法实现起来稍微有点儿绕，还有个粗暴点儿的解决方案：不去检测具体参数，只判断当前任务队列里的任务数是否超过某个值，一旦超过，就启动强制去重（只要参数列表或根路径相同，直接去掉，可能会误杀很多伪静态）。</p>
<p>在实现了上述的六个需求后，一个简洁有效的去重脚本就完成了，流程图如下：</p>
<p><img src="http://ok8ftn6n6.bkt.clouddn.com/939685-659c4858790aac30.png" alt="去重"></p>
<h2 id="0x05-对比"><a href="#0x05-对比" class="headerlink" title="0x05 对比"></a>0x05 对比</h2><p>为了测试动态爬虫（以下简称KSpider）的基本功能和效率，选取了同样是基于动态分析的WVS扫描器的爬虫（以下简称WVSSpider）来对比。</p>
<p>首先测试基本抓取功能。<a href="http://demo.aisec.cn/demo/aisec/" target="_blank" rel="external">AISec漏洞扫描器测试平台</a> 提供了几个demo，爬取结果如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"># 注： WVSSpider无法设置爬虫深度及线程数，针对path相同的url会进行聚合处理，生成SiteFile。</div><div class="line">WVSSpider # wvs_console.exe /Crawl http://demo.aisec.cn/demo/aisec/ /SaveLogs /SaveFolder C:\Users\xxx\Desktop /ExportXML </div><div class="line">Request Count: 31, SiteFile Count: 11, Time Count: 23</div><div class="line"></div><div class="line">KSpider # python crawler.py http://demo.aisec.cn/demo/aisec/ &#123;&quot;depth&quot;: 5, &quot;thread_count&quot;: 5&#125; </div><div class="line">Request Count: 23, Result Count: 18, Time Cost: 33</div><div class="line"></div><div class="line">KSpider Basic # python crawler.py http://demo.aisec.cn/demo/aisec/ &#123;&quot;depth&quot;: 5, &quot;thread_count&quot;: 5, &quot;type&quot;: &quot;basic&quot;&#125; </div><div class="line">Request Count: 11,  Result Count: 8, Time Cost: 1</div></pre></td></tr></table></figure>
<p>前两个扫描都抓取到了5个关键的请求，包括：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">基础&lt;a&gt;标签: http://demo.aisec.cn/demo/aisec/html_link.php?id=2</div><div class="line">JS自动解析: http://demo.aisec.cn/demo/aisec/js_link.php?id=2&amp;msg=abc</div><div class="line">JS自动解析 + FORM表单: http://demo.aisec.cn/demo/aisec/post_link.php</div><div class="line">JS自动解析 + AJAX请求: http://demo.aisec.cn/demo/aisec/ajax_link.php?id=1&amp;t=0.04278885293751955</div><div class="line">事件触发 + DOM改变: http://demo.aisec.cn/demo/aisec/click_link.php?id=2</div></pre></td></tr></table></figure>
<p>静态分析的扫描速度很快，但只扫出了上述5个请求中的第一个。通过表单分析抓取到了第三个POST请求，但是由于<code>&lt;form&gt;</code>表单中的<code>&lt;input&gt;</code>标签是由JavaScript动态生成（代码如下），所以没有抓取到请求的具体参数。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&lt;form method=&quot;post&quot; name=&quot;form1&quot; enctype=&quot;multipart/form-data&quot; action=&quot;post_link.php&quot;&gt;</div><div class="line">&lt;script&gt;</div><div class="line">document.write(&apos;&lt;input type=&quot;text&quot; name=&quot;i&apos;+&apos;d&quot; size=&quot;30&quot; value=1&gt;&lt;br&gt;&apos;);</div><div class="line">document.write(&apos;&lt;input type=&quot;text&quot; name=&quot;m&apos;+&apos;sg&quot; size=&quot;30&quot; value=&quot;abc&quot;&gt;&apos;);</div><div class="line">&lt;/script&gt;</div><div class="line">&lt;input type=&quot;submit&quot; value=&quot;提交&quot; name=&quot;B1&quot;&gt;</div><div class="line">&lt;/form&gt;</div></pre></td></tr></table></figure>
<p>接下来是爬虫的效率测试，抓取目标是 <a href="https://tieba.baidu.com/index.html" target="_blank" rel="external">百度贴吧</a>。结果如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">WVSSpider # wvs_console.exe /Crawl https://tieba.baidu.com /SaveLogs /SaveFolder C:\Users\xxx\Desktop /ExportXML </div><div class="line">Request Count: 201, SiteFile Count: 101, Time Count: 220</div><div class="line"></div><div class="line">KSpider # python crawler.py https://tieba.baidu.com &#123;&quot;depth&quot;: 5, &quot;thread_count&quot;: 10&#125; </div><div class="line">Request Count: 410, Result_length: 535, Time_Cost: 339</div></pre></td></tr></table></figure>
<p>可以看到，随着网站复杂度的上升，WVS爬虫的请求数增长相对平稳，而KSpider在线程数为10的情况下，在6分钟内也完成了爬取任务，表现正常。</p>
<p>在分析过程中，虽然 WVSSpider 速度很快，整体效率非常高，但也有一些缺点：爬取深度无法指定、无法跨平台工作、对于伪静态形式的URL去重效果较差（如下图所示的SiteFile共有43个，占比42%）、爬虫结果中有部分URL分割结果（如：<code>https://tieba.baidu.com/home/main?un=111</code> 会分割成两个SiteFile，<code>/home</code> 和 <code>/home/main</code>，所以实际扫描到的URL数量比结果要少）等。</p>
<p><img src="http://ok8ftn6n6.bkt.clouddn.com/939685-3bca879cb00e6cb7.png" alt="WVS部分爬取结果"></p>
<p>由于目标网站URL较多，覆盖率比较难测算，我们用脚本简单对比了 WVSSpider 和 KSpider 抓取的结果，除去静态资源，KSpider 覆盖了98%的 WVSSpider 抓取结果（即 WVSSpider 抓取结果里，有98%的结果同样被 KSpider 抓到），而 WVSSpider 仅覆盖了38%的 KSpider 抓取结果。</p>
<h2 id="0x06-总结"><a href="#0x06-总结" class="headerlink" title="0x06 总结"></a>0x06 总结</h2><p>除了以上提到的去重和动态解析，还有一些小tips，如fuzz常见路径、从robots.txt中提取信息、爬取过程中进行敏感信息识别、生成网站信息画像等，对爬虫的覆盖率及后续的扫描任务会有帮助。</p>
<p>本文详细的介绍了在动态爬虫的实现过程中，可能会遇到的问题以及解决方案。优秀的代码不会一蹴而就，需要持续的优化调整，后期会考虑开源，欢迎沟通交流。</p>
<p>参考资料:<br><a href="http://blog.cooer.net/2014/%e8%ae%a9%e4%ba%ba%e6%ac%a2%e5%96%9c%e8%ae%a9%e6%88%91%e5%bf%a7%e7%9a%84phantomjs/" target="_blank" rel="external">让人欢喜让我忧的phantomjs</a><br><a href="http://www.jianshu.com/p/9d408e21dc3a/comments/6037364" target="_blank" rel="external">盘点selenium phantomJS使用的坑</a><br><a href="https://security.tencent.com/index.php/blog/msg/34" target="_blank" rel="external">SuperSpider——打造功能强大的爬虫利器</a><br><a href="https://www.n0tr00t.com/2016/10/29/XSS_dynamic_detection_using_PhantomJs.html" target="_blank" rel="external">XSS dynamic detection using PhantomJs</a></p>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://yoursite.com/2017/01/10/crawler_and_filter/" data-id="ciya5axf80004ow9xmzlou9u4" class="article-share-link">Share</a><div class="tags"><a href="/tags/crawler/">crawler</a><a href="/tags/filter/">filter</a></div><div class="post-nav"><a href="/2016/09/07/XSS_Tricks_从self-XSS到上了你的百度/" class="next">XSS Tricks:从self-XSS到上了你的百度</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> Tags</i></div><div class="tagcloud"><a href="/tags/tools/" style="font-size: 15px;">tools</a> <a href="/tags/python/" style="font-size: 15px;">python</a> <a href="/tags/xss/" style="font-size: 15px;">xss</a> <a href="/tags/crawler/" style="font-size: 15px;">crawler</a> <a href="/tags/filter/" style="font-size: 15px;">filter</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/php/" style="font-size: 15px;">php</a> <a href="/tags/sql/" style="font-size: 15px;">sql</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> Recent</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/01/10/crawler_and_filter/">浅谈动态爬虫与去重</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/07/XSS_Tricks_从self-XSS到上了你的百度/">XSS Tricks:从self-XSS到上了你的百度</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/05/XSS_dynamic_detection_using_PhantomJs/">XSS dynamic detection using PhantomJs</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/10/13/php_audit_is_numeric/">危险的is_numeric——PHPYun 2015-06-26 二次注入漏洞分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/09/22/WVS_Patcher/">WVS_Patcher</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/09/05/python_weak_pass_scaner/">基于Python+协程+多进程的通用弱密码扫描器</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/06/16/xss_firewall/">XSS前端防火墙</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/06/04/python_http_put/">HTTP - PUT 上传文件/Shell</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/04/11/sql_injection_by_hand/">手工SQL注入详解</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/03/02/thinkphp_safety_analysiz/">ThinkPHP框架安全实现分析</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> Friend links</i></div><ul></ul><a href="http://www.0aa.me/" title="Mosuan's blog" target="_blank">Mosuan's blog</a><ul></ul><a href="https://cyhhao.zhusun.in/" title="cyhhao 's Blog" target="_blank">cyhhao 's Blog</a><ul></ul><a href="http://py0.me/blog/" title="RedFree's Blog" target="_blank">RedFree's Blog</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <a href="/." rel="nofollow">Fr1day's Blog.</a> <a href="http://www.miitbeian.gov.cn/" rel="nofollow" target="_blank"> 鲁ICP备16045369号.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>
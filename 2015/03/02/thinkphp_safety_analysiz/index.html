<!DOCTYPE html><html lang="en"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>ThinkPHP框架安全实现分析 | Fr1day's Blog</title><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/5.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-min.css"><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">ThinkPHP框架安全实现分析</h1><a id="logo" href="/.">Fr1day's Blog</a><p class="description"></p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> Home</i></a><a href="/archives/"><i class="fa fa-archive"> Archive</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">ThinkPHP框架安全实现分析</h1><div class="post-meta">Mar 2, 2015<script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><div class="post-content"><p>ThinkPHP框架是国内比较流行的PHP框架之一，虽然跟国外的那些个框架没法比，但优点在于，恩，中文手册很全面。最近研究SQL注入，之前用TP框架的时候因为底层提供了安全功能，在开发过程中没怎么考虑安全问题。想知道TP到底是怎么实现防SQL注入的，所以看了一些源码。结合phith0n大牛在乌云上发的漏洞，分析了一下，整理了一些思路~~</p>
<h1 id="0x00-不得不说的I函数"><a href="#0x00-不得不说的I函数" class="headerlink" title="0x00 不得不说的I函数"></a>0x00 不得不说的I函数</h1><p>TP系统提供了I函数用于输入变量的过滤。整个函数主体的意义就是获取各种格式的数据，比如<code>I(&#39;get.&#39;)</code>、<code>I(&#39;post.id&#39;)</code>，然后用<code>htmlspecialchars</code>函数（默认情况下）进行处理。如果需要采用其他的方法进行安全过滤，可以从<code>/ThinkPHP/Conf/convention.php</code>中设置：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div></pre></td><td class="code"><pre><div class="line"><span class="string">'DEFAULT_FILTER'</span>        =&gt;  <span class="string">'strip_tags'</span>,</div><div class="line"><span class="comment">//也可以设置多种过滤方法</span></div><div class="line"><span class="string">'DEFAULT_FILTER'</span>        =&gt;  <span class="string">'strip_tags,stripslashes'</span>,</div><div class="line">从/ThinkPHP/Common/functions.php中可以找到I函数，源码如下：</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 获取输入参数 支持过滤和默认值</div><div class="line"> * 使用方法:</div><div class="line"> * &lt;code&gt;</div><div class="line"> * I('id',0); 获取id参数 自动判断get或者post</div><div class="line"> * I('post.name','','htmlspecialchars'); 获取$_POST['name']</div><div class="line"> * I('get.'); 获取$_GET</div><div class="line"> * &lt;/code&gt;</div><div class="line"> * <span class="doctag">@param</span> string $name 变量的名称 支持指定类型</div><div class="line"> * <span class="doctag">@param</span> mixed $default 不存在的时候默认值</div><div class="line"> * <span class="doctag">@param</span> mixed $filter 参数过滤方法</div><div class="line"> * <span class="doctag">@param</span> mixed $datas 要获取的额外数据源</div><div class="line"> * <span class="doctag">@return</span> mixed</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">I</span><span class="params">($name,$default=<span class="string">''</span>,$filter=null,$datas=null)</span> </span>&#123;</div><div class="line">    <span class="keyword">static</span> $_PUT    =    <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">if</span>(strpos($name,<span class="string">'/'</span>))&#123; <span class="comment">// 指定修饰符</span></div><div class="line">        <span class="keyword">list</span>($name,$type)     =    explode(<span class="string">'/'</span>,$name,<span class="number">2</span>);</div><div class="line">    &#125;<span class="keyword">elseif</span>(C(<span class="string">'VAR_AUTO_STRING'</span>))&#123; <span class="comment">// 默认强制转换为字符串</span></div><div class="line">        $type   =   <span class="string">'s'</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/*根据$name的格式获取数据：先判断参数的来源，然后再根据各种格式获取数据*/</span></div><div class="line">    <span class="keyword">if</span>(strpos($name,<span class="string">'.'</span>)) &#123;<span class="keyword">list</span>($method,$name) =   explode(<span class="string">'.'</span>,$name,<span class="number">2</span>);&#125; <span class="comment">// 指定参数来源</span></div><div class="line">    <span class="keyword">else</span>&#123;$method =   <span class="string">'param'</span>;&#125;<span class="comment">//设定为自动获取</span></div><div class="line">    <span class="keyword">switch</span>(strtolower($method)) &#123;</div><div class="line">        <span class="keyword">case</span> <span class="string">'get'</span>     :   $input =&amp; $_GET;<span class="keyword">break</span>;</div><div class="line">        <span class="keyword">case</span> <span class="string">'post'</span>    :   $input =&amp; $_POST;<span class="keyword">break</span>;</div><div class="line">        <span class="keyword">case</span> <span class="string">'put'</span>     :   <span class="comment">/*此处省略*/</span></div><div class="line">        <span class="keyword">case</span> <span class="string">'param'</span>   :   <span class="comment">/*此处省略*/</span></div><div class="line">        <span class="keyword">case</span> <span class="string">'path'</span>    :   <span class="comment">/*此处省略*/</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/*对获取的数据进行过滤*/</span></div><div class="line">    <span class="keyword">if</span>(<span class="string">''</span> <span class="comment">// 获取全部变量</span></div><div class="line">        $data       =   $input;</div><div class="line">        $filters    =   <span class="keyword">isset</span>($filter)?$filter:C(<span class="string">'DEFAULT_FILTER'</span>);</div><div class="line">        <span class="keyword">if</span>($filters) &#123;</div><div class="line">            <span class="keyword">if</span>(is_string($filters))&#123;$filters    =   explode(<span class="string">','</span>,$filters);&#125; <span class="comment">//为多种过滤方法提供支持</span></div><div class="line">            <span class="keyword">foreach</span>($filters <span class="keyword">as</span> $filter)&#123;</div><div class="line">                $data   =   array_map_recursive($filter,$data); <span class="comment">//循环过滤</span></div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;<span class="keyword">elseif</span>(<span class="keyword">isset</span>($input[$name])) &#123; <span class="comment">// 取值操作</span></div><div class="line">        $data       =   $input[$name];</div><div class="line">        $filters    =   <span class="keyword">isset</span>($filter)?$filter:C(<span class="string">'DEFAULT_FILTER'</span>);</div><div class="line">        <span class="keyword">if</span>($filters) &#123;      <span class="comment">/*对参数进行过滤，支持正则表达式验证*/</span></div><div class="line">            <span class="comment">/*此处省略*/</span></div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span>(!<span class="keyword">empty</span>($type))&#123;  <span class="comment">//如果设定了强制转换类型</span></div><div class="line">            <span class="keyword">switch</span>(strtolower($type))&#123;</div><div class="line">                <span class="keyword">case</span> <span class="string">'a'</span>: $data = (<span class="keyword">array</span>)$data;<span class="keyword">break</span>;   <span class="comment">// 数组  </span></div><div class="line">                <span class="keyword">case</span> <span class="string">'d'</span>: $data = (int)$data;<span class="keyword">break</span>;   <span class="comment">// 数字 </span></div><div class="line">                <span class="keyword">case</span> <span class="string">'f'</span>: $data = (float)$data;<span class="keyword">break</span>;    <span class="comment">// 浮点   </span></div><div class="line">                <span class="keyword">case</span> <span class="string">'b'</span>: $data = (boolean)$data;<span class="keyword">break</span>;    <span class="comment">// 布尔</span></div><div class="line">                <span class="keyword">case</span> <span class="string">'s'</span>:   <span class="comment">// 字符串</span></div><div class="line">                <span class="keyword">default</span>:$data   =   (string)$data;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;<span class="keyword">else</span>&#123; <span class="comment">// 变量默认值</span></div><div class="line">        $data       =    <span class="keyword">isset</span>($default)?$default:<span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    is_array($data) &amp;&amp; array_walk_recursive($data,<span class="string">'think_filter'</span>);  <span class="comment">//如果$data是数组，那么用think_filter对数组过滤</span></div><div class="line">    <span class="keyword">return</span> $data;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>函数基本分成三块：第一块，获取各种格式的数据。第二块，对获取的数据进行循环编码，不管是二维数组还是三维数组。第三块，也就是倒数第二行，调用了think_filter对数据进行了最后一步的神秘处理。</p>
<p>让我们先来追踪一下think_filter函数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//1536行 版本3.2.3最新添加</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">think_filter</span><span class="params">(&amp;$value)</span></span>&#123;<span class="comment">// 过滤查询特殊字符    </span></div><div class="line">    <span class="keyword">if</span>(preg_match(<span class="string">'/^(EXP|NEQ|GT|EGT|LT|ELT|OR|XOR|LIKE|NOTLIKE|NOT BETWEEN|NOTBETWEEN|BETWEEN|NOTIN|NOT IN|IN)$/i'</span>,$value))&#123;        </div><div class="line">        $value .= <span class="string">' '</span>;    </div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这个函数很简单，一眼就可以看出来，在一些特定的关键字后面加个空格。但是这个叫<code>think_filter</code>的函数，仅仅加了一个空格，到底起到了什么过滤的作用？</p>
<p>我们都知道重要的逻辑验证，如验证是否已登录，用户是否能购买某商品等，必须从服务器端验证，如果从前端验证的话，就很容易被绕过。同一个道理，在程序中，in/exp一类的逻辑结构，最好也是由服务器端来控制。</p>
<p>当从传递到服务器端的数据是这样：<code>id[0]=in&amp;id[1]=1,2,3</code>，如果没有<code>think_filte</code>r函数的话，会被解析成下表中的1，也就会被当成服务器端逻辑解析。但如果变成如下表2的样子，因为多了一个空格，无法被匹配解析，也就避免了漏洞。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="number">1.</span> $data[<span class="string">'id'</span>]=<span class="keyword">array</span>(<span class="string">'in'</span>=&gt;<span class="string">'1,2,3'</span>)  </div><div class="line"></div><div class="line"><span class="comment">//经过think_filter过滤之后，会变成介个样子：</span></div><div class="line"><span class="number">2.</span> $data[<span class="string">'id'</span>]=<span class="keyword">array</span>(<span class="string">'in '</span>=&gt;<span class="string">'1,2,3'</span>)</div></pre></td></tr></table></figure>
<h1 id="0x10-SQL注入"><a href="#0x10-SQL注入" class="headerlink" title="0x10 SQL注入"></a>0x10 SQL注入</h1><p>相关的文件为:<code>/ThinkPHP/Library/Think/Db.class.php</code>(在3.2.3中改为了<code>/ThinkPHP/Library/Think/Db/Driver.class.php</code>) 以及 <code>/ThinkPHP/Library/Think/Model.class.php</code>。其中<code>Model.class.php</code>文件提供的是curd直接调用的函数，直接对外提供接口，<code>Driver.class.php</code>中的函数被curd操作间接调用。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//此次主要分析如下语句：</span></div><div class="line">M(<span class="string">'user'</span>)-&gt;where($map)-&gt;find();    <span class="comment">//在user表根据$map的条件检索出一条数据</span></div></pre></td></tr></table></figure>
<p>大概说一下TP的处理思路。首先将Model类实例化为一个user对象，然后调用user对象中的where函数处理$map，也就是将$map进行一些格式化处理之后赋值给user对象的成员变量$options（如果有其他的连贯操作，也是先赋值给user对象的对应成员变量，而不是直接拼接SQL语句，所以在写连贯操作的时候，无需像拼接SQL语句一样考虑关键字的顺序），接下来调用find函数。find函数会调用底层的，也就是driver类中的函数——select来获取数据。到了select函数，又是另一个故事了。</p>
<p>select除了要处理curd操作，还要处理pdo绑定，我们这里只关心curd操作，所以在select中调用了<code>buildSelectSql</code>，处理分页信息，并且调用<code>parseSQL</code>按照既定的顺序把SQL语句组装进去。虽然拼接SQL语句所需要的参数已经全部放在成员变量里了，但是格式不统一，有可能是字符串格式的，有可能是数组格式的，还有可能是TP提供的特殊查询格式，比如：<code>$data[&#39;id&#39;]=array(&#39;gt&#39;,&#39;100&#39;);</code>，所以在拼接之前，还要调用各自的处理函数，进行统一的格式化处理。我选取了<code>parseWhere</code>这个复杂的典型来分析。</p>
<p>关于安全方面的，如果用I函数来获取数据，那么会默认进行<code>htmlspecialchars</code>处理，能有效抵御xss攻击，但是对SQL注入没有多大影响。在过滤有关SQL注入有关的符号的时候，TP的做法很机智：先是按正常逻辑处理用户的输入，然后在最接近最终的SQL语句的<code>parseWhere</code>、<code>parseHaving</code>等函数中进行安全处理。这样的顺序避免了在处理的过程中出现注入。当然处理的方法是最普通的<code>addslashes</code>，根据死在沙滩上的前浪们说，推荐使用<code>mysql_real_escape_string</code>来进行过滤，但是这个函数只能在已经连接了数据库的前提下使用。感觉TP在这个地方可以做一下优化，毕竟走到这一步的都是连接了数据库的。</p>
<p>恩，接下来，分析开始：</p>
<p>先说几个Model对象中的成员变量：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 主键名称</span></div><div class="line"><span class="keyword">protected</span> $pk      = <span class="string">'id'</span>;</div><div class="line"><span class="comment">// 字段信息</span></div><div class="line"><span class="keyword">protected</span> $fields  = <span class="keyword">array</span>();</div><div class="line"><span class="comment">// 数据信息</span></div><div class="line"><span class="keyword">protected</span> $data    = <span class="keyword">array</span>();</div><div class="line"><span class="comment">// 查询表达式参数</span></div><div class="line"><span class="keyword">protected</span> $options = <span class="keyword">array</span>();</div><div class="line"><span class="comment">// 链操作方法列表</span></div><div class="line"><span class="keyword">protected</span> $methods = <span class="keyword">array</span>(<span class="string">'strict'</span>,<span class="string">'order'</span>,<span class="string">'alias'</span>,<span class="string">'having'</span>,<span class="string">'group'</span>,<span class="string">'lock'</span>,<span class="string">'distinct'</span>,<span class="string">'auto'</span>,<span class="string">'filter'</span>,<span class="string">'validate'</span>,<span class="string">'result'</span>,<span class="string">'token'</span>,<span class="string">'index'</span>,<span class="string">'force'</span>)</div></pre></td></tr></table></figure>
<p>接下来分析where函数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">where</span><span class="params">($where,$parse=null)</span></span>&#123;</div><div class="line">    <span class="comment">//如果非数组格式，即where('id=%d&amp;name=%s',array($id,$name))，对传递到字符串中的数组调用mysql里的escapeString进行处理</span></div><div class="line">    <span class="keyword">if</span>(!is_null($parse) &amp;&amp; is_string($where)) &#123; </div><div class="line">        <span class="keyword">if</span>(!is_array($parse))&#123;  $parse = func_get_args();array_shift($parse);&#125;</div><div class="line">        $parse = array_map(<span class="keyword">array</span>(<span class="keyword">$this</span>-&gt;db,<span class="string">'escapeString'</span>),$parse);</div><div class="line">        $where = vsprintf($where,$parse); <span class="comment">//vsprintf() 函数把格式化字符串写入变量中</span></div><div class="line">    &#125;<span class="keyword">elseif</span>(is_object($where))&#123;</div><div class="line">        $where  =   get_object_vars($where);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span>(is_string($where) &amp;&amp; <span class="string">''</span> != $where)&#123;</div><div class="line">        $map    =   <span class="keyword">array</span>();</div><div class="line">        $map[<span class="string">'_string'</span>]   =   $where;</div><div class="line">        $where  =   $map;</div><div class="line">    &#125;      </div><div class="line"></div><div class="line">    <span class="comment">//将$where赋值给$this-&gt;where</span></div><div class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;options[<span class="string">'where'</span>]))&#123;         </div><div class="line">        <span class="keyword">$this</span>-&gt;options[<span class="string">'where'</span>] =   array_merge(<span class="keyword">$this</span>-&gt;options[<span class="string">'where'</span>],$where);</div><div class="line">    &#125;<span class="keyword">else</span>&#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;options[<span class="string">'where'</span>] =   $where;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>where函数的逻辑很简单，如果是<code>where(&#39;id=%d&amp;name=%s&#39;,array($id,$name))</code>这种格式，那就对<code>$id,$name</code>变量调用mysql里的<code>escapeString</code>进行处理。<code>escapeString</code>的实质是调<code>用mysql_real_escape_string</code>、<code>addslashes</code>等函数进行处理。最后将分析之后的数组赋值到Model对象的成员函数——$where中供下一步处理。</p>
<p>再分析find函数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//model.class.php    行721    版本3.2.3</span></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">find</span><span class="params">($options=array<span class="params">()</span>)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span>(is_numeric($options) || is_string($options))&#123; <span class="comment">/*如果传递过来的数据是字符串，不是数组*/</span></div><div class="line">        $where[<span class="keyword">$this</span>-&gt;getPk()]  =   $options;</div><div class="line">        $options                =   <span class="keyword">array</span>();</div><div class="line">        $options[<span class="string">'where'</span>]       =   $where; <span class="comment">/*提取出查询条件，并赋值*/</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 根据主键查找记录</span></div><div class="line">    $pk  =  <span class="keyword">$this</span>-&gt;getPk();</div><div class="line">    <span class="keyword">if</span> (is_array($options) &amp;&amp; (count($options) &gt; <span class="number">0</span>) &amp;&amp; is_array($pk)) &#123;</div><div class="line">        <span class="comment">/*构造复合主键查询条件，此处省略*/</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    $options[<span class="string">'limit'</span>]   =   <span class="number">1</span>;                                  <span class="comment">// 总是查找一条记录</span></div><div class="line">    $options            =   <span class="keyword">$this</span>-&gt;_parseOptions($options);     <span class="comment">// 分析表达式</span></div><div class="line"></div><div class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>($options[<span class="string">'cache'</span>]))&#123;</div><div class="line">        <span class="comment">/*缓存查询，此处省略*/</span></div><div class="line">    &#125;</div><div class="line">    $resultSet = <span class="keyword">$this</span>-&gt;db-&gt;select($options);</div><div class="line"></div><div class="line">    <span class="keyword">if</span>(<span class="keyword">false</span> === $resultSet)&#123;   <span class="keyword">return</span> <span class="keyword">false</span>;&#125;</div><div class="line">    <span class="keyword">if</span>(<span class="keyword">empty</span>($resultSet)) &#123;    <span class="keyword">return</span> <span class="keyword">null</span>; &#125;           <span class="comment">// 查询结果为空       </span></div><div class="line">    <span class="keyword">if</span>(is_string($resultSet))&#123;   <span class="keyword">return</span> $resultSet;&#125;    <span class="comment">//查询结果为字符串</span></div><div class="line"></div><div class="line">    <span class="comment">// 读取数据后的处理，此处省略简写</span></div><div class="line">    <span class="keyword">$this</span>-&gt;data = <span class="keyword">$this</span>-&gt;_read_data($resultSet[<span class="number">0</span>]);</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;data;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>$Pk为主键，$options为表达式参数，本函数的作用就是完善成员变量——options数组，然后调用db层的select函数查询数据，处理后返回数据。</p>
<p>跟进_parseOptions函数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">_parseOptions</span><span class="params">($options=array<span class="params">()</span>)</span> </span>&#123; <span class="comment">//分析表达式</span></div><div class="line">    <span class="keyword">if</span>(is_array($options))&#123;</div><div class="line">        $options =  array_merge(<span class="keyword">$this</span>-&gt;options,$options);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/*获取表名，此处省略*/</span></div><div class="line">    <span class="comment">/*添加数据表别名，此处省略*/</span></div><div class="line"></div><div class="line">    $options[<span class="string">'model'</span>]       =   <span class="keyword">$this</span>-&gt;name;<span class="comment">// 记录操作的模型名称</span></div><div class="line"></div><div class="line">    <span class="comment">/*对数组查询条件进行字段类型检查，如果在合理范围内，就进行过滤处理；否则抛出异常或者删除掉对应字段*/</span></div><div class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>($options[<span class="string">'where'</span>]) &amp;&amp; is_array($options[<span class="string">'where'</span>]) &amp;&amp; !<span class="keyword">empty</span>($fields) &amp;&amp; !<span class="keyword">isset</span>($options[<span class="string">'join'</span>]))&#123;</div><div class="line">        <span class="keyword">foreach</span> ($options[<span class="string">'where'</span>] <span class="keyword">as</span> $key=&gt;$val)&#123;</div><div class="line">            $key = trim($key);</div><div class="line">            <span class="keyword">if</span>(in_array($key,$fields,<span class="keyword">true</span>))&#123;    <span class="comment">//如果$key在数据库字段内，过滤以及强制类型转换之</span></div><div class="line">                <span class="keyword">if</span>(is_scalar($val)) &#123;  </div><div class="line">                <span class="comment">/*is_scalar 检测是否为标量。标量是指integer、float、string、boolean的变量，array则不是标量。*/</span>         </div><div class="line">                    <span class="keyword">$this</span>-&gt;_parseType($options[<span class="string">'where'</span>],$key);</div><div class="line">                &#125;</div><div class="line">            &#125;<span class="keyword">elseif</span>(!is_numeric($key) &amp;&amp; <span class="string">'_'</span> != substr($key,<span class="number">0</span>,<span class="number">1</span>) &amp;&amp; <span class="keyword">false</span> === strpos($key,<span class="string">'.'</span>) &amp;&amp; <span class="keyword">false</span> === strpos($key,<span class="string">'('</span>) &amp;&amp; <span class="keyword">false</span> === strpos($key,<span class="string">'|'</span>) &amp;&amp; <span class="keyword">false</span> === strpos($key,<span class="string">'&amp;'</span>))&#123;</div><div class="line">               <span class="comment">// 如果$key不是数字且第一个字符不是_，不存在.(|&amp;等特殊字符</span></div><div class="line">                <span class="keyword">if</span>(!<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;options[<span class="string">'strict'</span>]))&#123;   <span class="comment">//如果是strict模式，抛出异常</span></div><div class="line">                    E(L(<span class="string">'_ERROR_QUERY_EXPRESS_'</span>).<span class="string">':['</span>.$key.<span class="string">'=&gt;'</span>.$val.<span class="string">']'</span>);</div><div class="line">                &#125;   </div><div class="line">                <span class="keyword">unset</span>($options[<span class="string">'where'</span>][$key]); <span class="comment">//unset掉对应的值</span></div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125; </div><div class="line">    <span class="keyword">$this</span>-&gt;options  =   <span class="keyword">array</span>();            <span class="comment">// 查询过后清空sql表达式组装 避免影响下次查询</span></div><div class="line">    <span class="keyword">$this</span>-&gt;_options_filter($options);       <span class="comment">// 表达式过滤</span></div><div class="line">    <span class="keyword">return</span> $options;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>本函数的结构大概是，先获取了表名，模型名，再对数据进行处理：如果该条数据不在数据库字段内，则做出异常处理或者删除掉该条数据。否则，进行_parseType处理。parseType此处不再跟进，功能为:数据类型检测,强制类型转换包括int,float,bool型的三种数据。</p>
<p>函数运行到此处，就该把处理好的数据传到db层的select函数里了。此时的查询条件$options中的int,float,bool类型的数据都已经进行了强制类型转换，where（）函数中的字符串（非数组格式的查询）也进行了addslashes等处理。</p>
<p>继续追踪到select函数，就到了driver对象中了，还是先列举几个有用的成员变量：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 数据库表达式</span></div><div class="line"><span class="keyword">protected</span> $exp = <span class="keyword">array</span>(<span class="string">'eq'</span>=&gt;<span class="string">'='</span>,<span class="string">'neq'</span>=&gt;<span class="string">'&lt;&gt;'</span>,<span class="string">'gt'</span>=&gt;<span class="string">'&gt;'</span>,<span class="string">'egt'</span>=&gt;<span class="string">'&gt;='</span>,<span class="string">'lt'</span>=&gt;<span class="string">'&lt;'</span>,<span class="string">'elt'</span>=&gt;<span class="string">'&lt;='</span>,<span class="string">'notlike'</span>=&gt;<span class="string">'NOT LIKE'</span>,<span class="string">'like'</span>=&gt;<span class="string">'LIKE'</span>,<span class="string">'in'</span>=&gt;<span class="string">'IN'</span>,<span class="string">'notin'</span>=&gt;<span class="string">'NOT IN'</span>,<span class="string">'not in'</span>=&gt;<span class="string">'NOT IN'</span>,<span class="string">'between'</span>=&gt;<span class="string">'BETWEEN'</span>,<span class="string">'not between'</span>=&gt;<span class="string">'NOT BETWEEN'</span>,<span class="string">'notbetween'</span>=&gt;<span class="string">'NOT BETWEEN'</span>);</div><div class="line"><span class="comment">// 查询表达式</span></div><div class="line"><span class="keyword">protected</span> $selectSql  = <span class="string">'SELECT%DISTINCT% %FIELD% FROM %TABLE%%FORCE%%JOIN%%WHERE%%GROUP%%HAVING%%ORDER%%LIMIT% %UNION%%LOCK%%COMMENT%'</span>;</div><div class="line"><span class="comment">// 当前SQL指令</span></div><div class="line"><span class="keyword">protected</span> $queryStr   = <span class="string">''</span>;</div><div class="line"><span class="comment">// 参数绑定</span></div><div class="line"><span class="keyword">protected</span> $bind         =   <span class="keyword">array</span>();</div><div class="line">select函数：</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">select</span><span class="params">($options=array<span class="params">()</span>)</span> </span>&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;model  =   $options[<span class="string">'model'</span>];</div><div class="line">    <span class="keyword">$this</span>-&gt;parseBind(!<span class="keyword">empty</span>($options[<span class="string">'bind'</span>])?$options[<span class="string">'bind'</span>]:<span class="keyword">array</span>());</div><div class="line">    $sql    = <span class="keyword">$this</span>-&gt;buildSelectSql($options);</div><div class="line">    $result   = <span class="keyword">$this</span>-&gt;query($sql,!<span class="keyword">empty</span>($options[<span class="string">'fetch_sql'</span>]) ? <span class="keyword">true</span> : <span class="keyword">false</span>);</div><div class="line">    <span class="keyword">return</span> $result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>版本3.2.3经过改进之后，select精简了不少。parseBind函数是绑定参数，用于pdo查询，此处不表。</p>
<p>buildSelectSql（）函数及其后续调用如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">buildSelectSql</span><span class="params">($options=array<span class="params">()</span>)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>($options[<span class="string">'page'</span>])) &#123;</div><div class="line">        <span class="comment">/*页码计算及处理，此处省略*/</span></div><div class="line">    &#125;</div><div class="line">    $sql  =   <span class="keyword">$this</span>-&gt;parseSql(<span class="keyword">$this</span>-&gt;selectSql,$options);</div><div class="line">    <span class="keyword">return</span> $sql;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/* 替换SQL语句中表达式*/</span></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">parseSql</span><span class="params">($sql,$options=array<span class="params">()</span>)</span></span>&#123;</div><div class="line">    $sql   = str_replace(</div><div class="line">        <span class="keyword">array</span>(<span class="string">'%TABLE%'</span>,<span class="string">'%DISTINCT%'</span>,<span class="string">'%FIELD%'</span>,<span class="string">'%JOIN%'</span>,<span class="string">'%WHERE%'</span>,<span class="string">'%GROUP%'</span>,<span class="string">'%HAVING%'</span>,<span class="string">'%ORDER%'</span>,<span class="string">'%LIMIT%'</span>,<span class="string">'%UNION%'</span>,<span class="string">'%LOCK%'</span>,<span class="string">'%COMMENT%'</span>,<span class="string">'%FORCE%'</span>),</div><div class="line">        <span class="keyword">array</span>(</div><div class="line">            <span class="keyword">$this</span>-&gt;parseTable($options[<span class="string">'table'</span>]),</div><div class="line">            <span class="keyword">$this</span>-&gt;parseDistinct(<span class="keyword">isset</span>($options[<span class="string">'distinct'</span>])?$options[<span class="string">'distinct'</span>]:<span class="keyword">false</span>),</div><div class="line">            <span class="keyword">$this</span>-&gt;parseField(!<span class="keyword">empty</span>($options[<span class="string">'field'</span>])?$options[<span class="string">'field'</span>]:<span class="string">'*'</span>),</div><div class="line">            <span class="keyword">$this</span>-&gt;parseJoin(!<span class="keyword">empty</span>($options[<span class="string">'join'</span>])?$options[<span class="string">'join'</span>]:<span class="string">''</span>),</div><div class="line">            <span class="keyword">$this</span>-&gt;parseWhere(!<span class="keyword">empty</span>($options[<span class="string">'where'</span>])?$options[<span class="string">'where'</span>]:<span class="string">''</span>),</div><div class="line">            <span class="keyword">$this</span>-&gt;parseGroup(!<span class="keyword">empty</span>($options[<span class="string">'group'</span>])?$options[<span class="string">'group'</span>]:<span class="string">''</span>),</div><div class="line">            <span class="keyword">$this</span>-&gt;parseHaving(!<span class="keyword">empty</span>($options[<span class="string">'having'</span>])?$options[<span class="string">'having'</span>]:<span class="string">''</span>),</div><div class="line">            <span class="keyword">$this</span>-&gt;parseOrder(!<span class="keyword">empty</span>($options[<span class="string">'order'</span>])?$options[<span class="string">'order'</span>]:<span class="string">''</span>),</div><div class="line">            <span class="keyword">$this</span>-&gt;parseLimit(!<span class="keyword">empty</span>($options[<span class="string">'limit'</span>])?$options[<span class="string">'limit'</span>]:<span class="string">''</span>),</div><div class="line">            <span class="keyword">$this</span>-&gt;parseUnion(!<span class="keyword">empty</span>($options[<span class="string">'union'</span>])?$options[<span class="string">'union'</span>]:<span class="string">''</span>),</div><div class="line">            <span class="keyword">$this</span>-&gt;parseLock(<span class="keyword">isset</span>($options[<span class="string">'lock'</span>])?$options[<span class="string">'lock'</span>]:<span class="keyword">false</span>),</div><div class="line">            <span class="keyword">$this</span>-&gt;parseComment(!<span class="keyword">empty</span>($options[<span class="string">'comment'</span>])?$options[<span class="string">'comment'</span>]:<span class="string">''</span>),</div><div class="line">            <span class="keyword">$this</span>-&gt;parseForce(!<span class="keyword">empty</span>($options[<span class="string">'force'</span>])?$options[<span class="string">'force'</span>]:<span class="string">''</span>)</div><div class="line">        ),$sql);</div><div class="line">    <span class="keyword">return</span> $sql;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看到，在parseSql中用正则表达式拼接了sql语句，但并没有直接的去处理各种插叙你的数据格式，而是在解析变量的过程中调用了多个函数，此处拿parseWhere举例子。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">parseWhere</span><span class="params">($where)</span> </span>&#123;</div><div class="line">    $whereStr = <span class="string">''</span>;</div><div class="line">    <span class="keyword">if</span>(is_string($where)) &#123;     <span class="comment">// 直接使用字符串条件</span></div><div class="line">        $whereStr = $where;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span>&#123;                       <span class="comment">// 使用数组表达式</span></div><div class="line">        <span class="comment">/*设定逻辑规则，如or and xor等，默认为and，此处省略*/</span></div><div class="line">        $operate=<span class="string">' AND '</span>;</div><div class="line"></div><div class="line">        <span class="comment">/*解析特殊格式的表达式并且格式化输出*/</span></div><div class="line">        <span class="keyword">foreach</span> ($where <span class="keyword">as</span> $key=&gt;$val)&#123;</div><div class="line">            <span class="keyword">if</span>(<span class="number">0</span>===strpos($key,<span class="string">'_'</span>)) &#123;    <span class="comment">// 解析特殊条件表达式</span></div><div class="line">                $whereStr   .= <span class="keyword">$this</span>-&gt;parseThinkWhere($key,$val);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">else</span>&#123;                        <span class="comment">// 查询字段的安全过滤</span></div><div class="line">                $multi  = is_array($val) &amp;&amp;  <span class="keyword">isset</span>($val[<span class="string">'_multi'</span>]); <span class="comment">//判断是否有复合查询</span></div><div class="line">                $key    = trim($key);</div><div class="line">                <span class="comment">/*处理字段中包含的| &amp;逻辑*/</span></div><div class="line">                <span class="keyword">if</span>(strpos($key,<span class="string">'|'</span>)) &#123; <span class="comment">// 支持 name|title|nickname 方式定义查询字段</span></div><div class="line">                    <span class="comment">/*将|换成or，并格式化输出，此处省略*/</span></div><div class="line">                &#125;</div><div class="line">                <span class="keyword">elseif</span>(strpos($key,<span class="string">'&amp;'</span>))&#123;</div><div class="line">                    <span class="comment">/*将&amp;换成and，并格式化输出，此处省略*/</span></div><div class="line">                &#125;</div><div class="line">                <span class="keyword">else</span>&#123;</div><div class="line">                    $whereStr .= <span class="keyword">$this</span>-&gt;parseWhereItem(<span class="keyword">$this</span>-&gt;parseKey($key),$val);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            $whereStr .= $operate;</div><div class="line">        &#125;</div><div class="line">        $whereStr = substr($whereStr,<span class="number">0</span>,-strlen($operate));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">empty</span>($whereStr)?<span class="string">''</span>:<span class="string">' WHERE '</span>.$whereStr;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// where子单元分析</span></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">parseWhereItem</span><span class="params">($key,$val)</span> </span>&#123;</div><div class="line">    $whereStr = <span class="string">''</span>;</div><div class="line">    <span class="keyword">if</span>(is_array($val))&#123;</div><div class="line">        <span class="keyword">if</span>(is_string($val[<span class="number">0</span>]))&#123;</div><div class="line">            $exp    =   strtolower($val[<span class="number">0</span>]);</div><div class="line">            <span class="comment">//如果是$map['id']=array('eq',100)一类的结构，那么解析成数据库可执行格式</span></div><div class="line">            <span class="keyword">if</span>(preg_match(<span class="string">'/^(eq|neq|gt|egt|lt|elt)$/'</span>,$exp))&#123;</div><div class="line">                $whereStr .= $key.<span class="string">' '</span>.<span class="keyword">$this</span>-&gt;exp[$exp].<span class="string">' '</span>.<span class="keyword">$this</span>-&gt;parseValue($val[<span class="number">1</span>]);</div><div class="line">            &#125;</div><div class="line">            <span class="comment">//如果是模糊查找格式</span></div><div class="line">            <span class="keyword">elseif</span>(preg_match(<span class="string">'/^(notlike|like)$/'</span>,$exp))&#123;<span class="comment">// 模糊查找,$map['name']=array('like','thinkphp%');</span></div><div class="line">                <span class="keyword">if</span>(is_array($val[<span class="number">1</span>])) &#123; <span class="comment">//解析格式如下：$map['b'] =array('notlike',array('%thinkphp%','%tp'),'AND');</span></div><div class="line">                    $likeLogic  =   <span class="keyword">isset</span>($val[<span class="number">2</span>])?strtoupper($val[<span class="number">2</span>]):<span class="string">'OR'</span>;    <span class="comment">//如果没有设定逻辑结构，则默认为OR</span></div><div class="line">                    <span class="keyword">if</span>(in_array($likeLogic,<span class="keyword">array</span>(<span class="string">'AND'</span>,<span class="string">'OR'</span>,<span class="string">'XOR'</span>)))&#123;</div><div class="line">                        <span class="comment">/* 根据逻辑结构，组合语句，此处省略*/</span></div><div class="line">                        $whereStr .= <span class="string">'('</span>.implode(<span class="string">' '</span>.$likeLogic.<span class="string">' '</span>,$like).<span class="string">')'</span>;                          </div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">else</span>&#123;</div><div class="line">                    $whereStr .= $key.<span class="string">' '</span>.<span class="keyword">$this</span>-&gt;exp[$exp].<span class="string">' '</span>.<span class="keyword">$this</span>-&gt;parseValue($val[<span class="number">1</span>]);</div><div class="line">                &#125;</div><div class="line">            &#125;<span class="keyword">elseif</span>(<span class="string">'bind'</span> == $exp )&#123; <span class="comment">// 使用表达式，pdo数据绑定</span></div><div class="line">                $whereStr .= $key.<span class="string">' = :'</span>.$val[<span class="number">1</span>];</div><div class="line">            &#125;<span class="keyword">elseif</span>(<span class="string">'exp'</span> == $exp )&#123; <span class="comment">// 使用表达式 $map['id']  = array('exp',' IN (1,3,8) ');</span></div><div class="line">                $whereStr .= $key.<span class="string">' '</span>.$val[<span class="number">1</span>];</div><div class="line">            &#125;<span class="keyword">elseif</span>(preg_match(<span class="string">'/^(notin|not in|in)$/'</span>,$exp))&#123; <span class="comment">//IN运算 $map['id']  = array('not in','1,5,8');</span></div><div class="line">                <span class="keyword">if</span>(<span class="keyword">isset</span>($val[<span class="number">2</span>]) &amp;&amp; <span class="string">'exp'</span>==$val[<span class="number">2</span>])&#123;</div><div class="line">                    $whereStr .= $key.<span class="string">' '</span>.<span class="keyword">$this</span>-&gt;exp[$exp].<span class="string">' '</span>.$val[<span class="number">1</span>];</div><div class="line">                &#125;<span class="keyword">else</span>&#123;</div><div class="line">                    <span class="keyword">if</span>(is_string($val[<span class="number">1</span>])) &#123;</div><div class="line">                         $val[<span class="number">1</span>] =  explode(<span class="string">','</span>,$val[<span class="number">1</span>]);</div><div class="line">                    &#125;</div><div class="line">                    $zone      =   implode(<span class="string">','</span>,<span class="keyword">$this</span>-&gt;parseValue($val[<span class="number">1</span>]));</div><div class="line">                    $whereStr .= $key.<span class="string">' '</span>.<span class="keyword">$this</span>-&gt;exp[$exp].<span class="string">' ('</span>.$zone.<span class="string">')'</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;<span class="keyword">elseif</span>(preg_match(<span class="string">'/^(notbetween|not between|between)$/'</span>,$exp))&#123; <span class="comment">//BETWEEN运算</span></div><div class="line">                $data = is_string($val[<span class="number">1</span>])? explode(<span class="string">','</span>,$val[<span class="number">1</span>]):$val[<span class="number">1</span>];</div><div class="line">                $whereStr .=  $key.<span class="string">' '</span>.<span class="keyword">$this</span>-&gt;exp[$exp].<span class="string">' '</span>.<span class="keyword">$this</span>-&gt;parseValue($data[<span class="number">0</span>]).<span class="string">' AND '</span>.<span class="keyword">$this</span>-&gt;parseValue($data[<span class="number">1</span>]);</div><div class="line">            &#125;<span class="keyword">else</span>&#123;  <span class="comment">//否则抛出异常</span></div><div class="line">                E(L(<span class="string">'_EXPRESS_ERROR_'</span>).<span class="string">':'</span>.$val[<span class="number">0</span>]);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span>&#123;   <span class="comment">//解析如：$map['status&amp;score&amp;title'] =array('1',array('gt','0'),'thinkphp','_multi'=&gt;true);</span></div><div class="line">            $count = count($val);</div><div class="line">            $rule  = <span class="keyword">isset</span>($val[$count<span class="number">-1</span>]) ? (is_array($val[$count<span class="number">-1</span>]) ? strtoupper($val[$count<span class="number">-1</span>][<span class="number">0</span>]) : strtoupper($val[$count<span class="number">-1</span>]) ) : <span class="string">''</span> ; </div><div class="line">            <span class="keyword">if</span>(in_array($rule,<span class="keyword">array</span>(<span class="string">'AND'</span>,<span class="string">'OR'</span>,<span class="string">'XOR'</span>)))&#123;</div><div class="line">                $count  = $count <span class="number">-1</span>;</div><div class="line">            &#125;<span class="keyword">else</span>&#123;</div><div class="line">                $rule   = <span class="string">'AND'</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">for</span>($i=<span class="number">0</span>;$i&lt;$count;$i++)&#123;</div><div class="line">                $data = is_array($val[$i])?$val[$i][<span class="number">1</span>]:$val[$i];</div><div class="line">                <span class="keyword">if</span>(<span class="string">'exp'</span>==strtolower($val[$i][<span class="number">0</span>])) &#123;</div><div class="line">                    $whereStr .= $key.<span class="string">' '</span>.$data.<span class="string">' '</span>.$rule.<span class="string">' '</span>;</div><div class="line">                &#125;<span class="keyword">else</span>&#123;</div><div class="line">                    $whereStr .= <span class="keyword">$this</span>-&gt;parseWhereItem($key,$val[$i]).<span class="string">' '</span>.$rule.<span class="string">' '</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            $whereStr = <span class="string">'( '</span>.substr($whereStr,<span class="number">0</span>,<span class="number">-4</span>).<span class="string">' )'</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">//对字符串类型字段采用模糊匹配</span></div><div class="line">        $likeFields   =   <span class="keyword">$this</span>-&gt;config[<span class="string">'db_like_fields'</span>];</div><div class="line">        <span class="keyword">if</span>($likeFields &amp;&amp; preg_match(<span class="string">'/^('</span>.$likeFields.<span class="string">')$/i'</span>,$key)) &#123;</div><div class="line">            $whereStr .= $key.<span class="string">' LIKE '</span>.<span class="keyword">$this</span>-&gt;parseValue(<span class="string">'%'</span>.$val.<span class="string">'%'</span>);</div><div class="line">        &#125;<span class="keyword">else</span> &#123;</div><div class="line">            $whereStr .= $key.<span class="string">' = '</span>.<span class="keyword">$this</span>-&gt;parseValue($val);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> $whereStr;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">parseThinkWhere</span><span class="params">($key,$val)</span> </span>&#123;     <span class="comment">//解析特殊格式的条件</span></div><div class="line">    $whereStr   = <span class="string">''</span>;</div><div class="line">    <span class="keyword">switch</span>($key) &#123;</div><div class="line">        <span class="keyword">case</span> <span class="string">'_string'</span>:$whereStr = $val;<span class="keyword">break</span>;                                  <span class="comment">// 字符串模式查询条件</span></div><div class="line">        <span class="keyword">case</span> <span class="string">'_complex'</span>:$whereStr = substr(<span class="keyword">$this</span>-&gt;parseWhere($val),<span class="number">6</span>);<span class="keyword">break</span>;    <span class="comment">// 复合查询条件</span></div><div class="line">        <span class="keyword">case</span> <span class="string">'_query'</span>:<span class="comment">// 字符串模式查询条件</span></div><div class="line">            <span class="comment">/*处理逻辑结构，并且格式化输出字符串，此处省略*/</span></div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="string">'( '</span>.$whereStr.<span class="string">' )'</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面的两个函数很长，我们再精简一些来看：<code>parseWhere</code>首先判断查询数据是不是字符串，如果是字符串，直接返回字符串，否则，遍历查询条件的数组，挨个解析。由于TP支持<code>_string</code>，<code>_complex</code>之类的特殊查询，调用了<code>parseThinkWhere</code>来处理，对于普通查询，就调用了<code>parseWhereItem</code>。在各自的处理过程中，都调用了<code>parseValue</code>，追踪一下，其实是用了<code>addslashes</code>来过滤，虽然<code>addslashes</code>在非utf-8编码的页面中会造成宽字节注入，但是如果页面和数据库均正确编码的话，还是没什么问题的。</p>
<p>本篇仅是抛砖引玉，轻喷!</p>
<p>参考资料一：<a href="http://wooyun.org/bugs/wooyun-2010-086737" target="_blank" rel="external">http://wooyun.org/bugs/wooyun-2010-086737</a><br>参考资料二：<a href="http://wooyun.org/bugs/wooyun-2010-087731" target="_blank" rel="external">http://wooyun.org/bugs/wooyun-2010-087731</a><br>参考资料三：<a href="http://wooyun.org/bugs/wooyun-2010-086742" target="_blank" rel="external">http://wooyun.org/bugs/wooyun-2010-086742</a></p>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://yoursite.com/2015/03/02/thinkphp_safety_analysiz/" data-id="ciya4l7mg000f649xo8hw7nhr" class="article-share-link">Share</a><div class="tags"><a href="/tags/php/">php</a></div><div class="post-nav"><a href="/2015/04/11/sql_injection_by_hand/" class="pre">手工SQL注入详解</a><a href="/2015/02/11/linux_iptables_note/" class="next">Linux私房菜——防火墙部分笔记</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> Tags</i></div><div class="tagcloud"><a href="/tags/tools/" style="font-size: 15px;">tools</a> <a href="/tags/python/" style="font-size: 15px;">python</a> <a href="/tags/xss/" style="font-size: 15px;">xss</a> <a href="/tags/crawler/" style="font-size: 15px;">crawler</a> <a href="/tags/filter/" style="font-size: 15px;">filter</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/php/" style="font-size: 15px;">php</a> <a href="/tags/sql/" style="font-size: 15px;">sql</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> Recent</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/01/10/crawler_and_filter/">浅谈动态爬虫与去重</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/07/XSS_Tricks_从self-XSS到上了你的百度/">XSS Tricks:从self-XSS到上了你的百度</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/07/05/xss_scan/">XSS动态检测</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/06/10/bypass_xss_auditor_using_bad_php_code/">绕过XSS过滤器：利用错误编写的PHP代码</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/10/13/php_audit_is_numeric/">危险的is_numeric——PHPYun 2015-06-26 二次注入漏洞分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/09/22/WVS_Patcher/">WVS_Patcher</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/09/05/python_weak_pass_scaner/">基于Python+协程+多进程的通用弱密码扫描器</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/06/16/xss_firewall/">XSS前端防火墙</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/06/04/python_http_put/">HTTP - PUT 上传文件/Shell</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/04/11/sql_injection_by_hand/">手工SQL注入详解</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> Friend links</i></div><ul></ul><a href="http://www.0aa.me/" title="Mosuan's blog" target="_blank">Mosuan's blog</a><ul></ul><a href="https://cyhhao.zhusun.in/" title="cyhhao 's Blog" target="_blank">cyhhao 's Blog</a><ul></ul><a href="http://py0.me/blog/" title="RedFree's Blog" target="_blank">RedFree's Blog</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <a href="/." rel="nofollow">Fr1day's Blog.</a> <a href="http://www.miitbeian.gov.cn/" rel="nofollow" target="_blank"> 鲁ICP备16045369号.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>